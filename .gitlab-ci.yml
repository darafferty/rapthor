# Copyright (C) 2020 ASTRON (Netherlands Institute for Radio Astronomy)
# SPDX-License-Identifier: GPL-3.0-or-later

workflow:
  rules:
    # Don't create a pipeline if it's a commit pipeline on a branch having an open merge request
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
    - when: always

.astron_repo: &if_astron_repo
  if: '$CI_SERVER_HOST == "git.astron.nl"'
.not_astron_repo: &if_not_astron_repo
  if: '$CI_SERVER_HOST != "git.astron.nl"'

stages:
 - prepare
 - build
 - linting
 - test
 - integration_and_deploy
 - publish
 - pages

build-base:
  stage: prepare
  image: docker:stable
  script:
    - docker build --tag ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}_base -f ./docker/ubuntu_20_04_base .
  rules:
    - <<: *if_astron_repo

# On the SKA repo - which does not have a docker cache - we need to push the base image to the gitlab registry which requires docker:dind
build-base-ska:
  stage: prepare
  image: docker:stable
  services:
    - docker:dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build --tag ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}_base -f ./docker/ubuntu_20_04_base .
    - docker push ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}_base
  rules:
    - <<: *if_not_astron_repo

build-integration:
  stage: prepare
  image: docker:stable
  script:
    - docker build --tag ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}_integration -f ./docker/ubuntu_20_04_integration .
  rules:
    - <<: *if_astron_repo

# On the SKA repo - which does not have a docker cache - we need to push the image for the integration to the gitlab registry which requires docker:dind
build-integration-ska:
  stage: prepare
  image: docker:stable
  services:
  - docker:dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build --tag ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}_integration -f ./docker/ubuntu_20_04_integration .
    - docker push ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}_integration
  rules:
    - <<: *if_not_astron_repo

clang-format:
  stage: linting
  image: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}_base
  script:
    - ./scripts/run-clang-format.sh
  allow_failure: true

idg-python:
  stage: build
  image: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}_base
  script:
    - mkdir build
    - cd build
    - cmake -DBUILD_WITH_PYTHON=ON ..
    - make install -j4

idg-release:
  stage: build
  image: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}_base
  script:
    - mkdir build
    - cd build
    - cmake ..
    - make install -j4

idg-debug:
  stage: build
  image: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}_base
  script:
    - mkdir build
    - cd build
    - cmake .. -DCMAKE_BUILD_TYPE=Debug
    - make install -j4
  rules:
    - when: on_success

idg-test:
  stage: test
  image: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}_base
  script:
    - mkdir build
    - cd build
    - cmake .. -DCMAKE_CXX_FLAGS="-coverage" -DCMAKE_EXE_LINKER_FLAGS="-coverage" -DBUILD_TESTING=On
    - make install -j4
    - export LD_LIBRARY_PATH=$(pwd)/lib:$LD_LIBRARY_PATH
    - ctest -j8 --output-on-failure -LE integration -T test
    # Use the most recent Test.xml output file in a subdirectory of Testing/
    - export XML=$(ls -t Testing/*/Test.xml | head -n1)
    - mv $XML unittests.xml
    # Capture coverage
    - gcovr -r .. -e '.*/tests/.*' -e '.*/CompilerIdCXX/.*' -e '.*/external/.*' --json -o run-unit.json
    - gcovr --add-tracefile run-unit.json --xml > coverage.xml
    - gcovr --add-tracefile run-unit.json
  rules:
    - when: on_success
  artifacts:
    paths:
      - build/run-unit.json
      - build/unittests.xml
    reports:
      junit: build/unittests.xml
      cobertura: build/coverage.xml

idg-integration-docker:
  stage: integration_and_deploy
  image: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}_integration
  before_script:
    - export HOME_DIR=$PWD
    # Install IDG
    - mkdir /opt/idg && mkdir -p build
    - cd build
    - cmake -DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Release -DWRITE_OUT_SCALAR_BEAM=ON -DBUILD_WITH_PYTHON=ON -DCMAKE_INSTALL_PREFIX=/opt/idg ..
    - make install -j4
    # Exported, since integrationstep tIDGCalDPStep needs this variable
    - export IDG_LIB=/opt/idg/lib
    - export LD_LIBRARY_PATH=$IDG_LIB:$LD_LIBRARY_PATH
    # Compile against wsclean
    - mkdir /wsclean && cd /wsclean && git clone https://gitlab.com/aroffringa/wsclean.git src
    - mkdir build && cd build
    - cmake -DCMAKE_PREFIX_PATH=/opt/idg -DCMAKE_INSTALL_PREFIX=/usr ../src
    - make install -j4
    - cd $HOME_DIR && rm -rf /wsclean
    # Install dp3
    - mkdir /dp3 && cd /dp3 && git clone https://github.com/lofar-astron/DP3.git src
    - mkdir build && cd build
    - cmake -DCMAKE_INSTALL_PREFIX=/usr ../src
    - make install -j4
    - cd $HOME_DIR && rm -rf /dp3
    - export DP3_LIB=/usr/lib
  script:
    # Return to idg build directory to run tests
    - cd build
    - ctest --output-on-failure -L integration
    # Test idg-cal scripts
    - cd $HOME_DIR/idg-cal/unit_tests
    - pytest .
  rules:
    - when: on_success

idg-integration-das:
  stage: integration_and_deploy
  tags:
    - ci_gpu
  needs: []
  before_script:
    # Makes it easy to find the idg source location later on
    - export CURRENT_SOURCE=$PWD
    - source scripts/load_modules.sh
    - python3 -m pip install --user --upgrade pip
    # Make sure h5py is build against the hdf5 library loaded by load_modules.sh
    # This is important when h5py is imported in embedded python code
    # and the main executable is also linked against the hdf5 library.
    # This happens for example when DPPP is running a PythonDPStep that is
    # importing h5py
    - HDF5_DIR=${HDF5_ROOT} python3 -m pip install h5py --user --no-binary=h5py --force-reinstall --no-deps
    - python3 -m pip install --user astropy scipy pytest pytest-lazy-fixture h5py matplotlib
    # pytest executable is installed in local/bin. Add to PATH
    - export PATH=$PATH:/home/gitlab-runner/.local/bin
    # Install idg
    - mkdir -p ~/opt/idg && cd ~/opt/idg  && rm -rf *
    # Copy source code to src
    - mkdir src && cp -r $CURRENT_SOURCE/. src/.
    - mkdir build && cd build
    # Build with GPU libs
    - cmake -DBUILD_LIB_CUDA=On -DBUILD_TESTING=On -DCMAKE_BUILD_TYPE=Release -DWRITE_OUT_SCALAR_BEAM=ON -DBUILD_WITH_PYTHON=ON -DCMAKE_INSTALL_PREFIX=.. ../src
    - make install -j4
    # Exported, since integrationstep tIDGCalDPStep needs this variable
    - export IDG_LIB=~/opt/idg/lib
    - export LD_LIBRARY_PATH=$IDG_LIB:$LD_LIBRARY_PATH
    # Install wsclean (needs libgsl)
    - mkdir -p ~/opt/wsclean && cd ~/opt/wsclean && rm -rf *
    - git clone https://gitlab.com/aroffringa/wsclean.git src
    - mkdir build && cd build
    - cmake -DCFITSIO_ROOT_DIR=${CFITSIO_ROOT_DIR} -DCASACORE_ROOT_DIR=${CASACORE_ROOT_DIR} -DCMAKE_PREFIX_PATH="~/opt/idg;${EVERYBEAM_ROOT_DIR};${FFTW3_ROOT_DIR}" -DCMAKE_INSTALL_PREFIX=.. ../src
    - make install -j4
    - export PATH=$PATH:~/opt/wsclean/bin
  script:
    - export OPENBLAS_NUM_THREADS=1
    - cd ~/opt/idg/build
    # Run unit tests (more precisely: the non-integration tests)
    - ctest -j8 --output-on-failure -LE integration
    - echo "Finished unit tests"
    # Run integration tests
    - "python3 -m pip install --user --only-binary=:all: python-casacore"
    - ctest --output-on-failure -L integration
    # Test idg-cal scripts
    - cd $CURRENT_SOURCE/idg-cal/unit_tests
    - pytest .
  rules:
    - <<: *if_astron_repo

pages:
  stage: pages
  image: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}_base
  needs: ["idg-test"]
  before_script:
    - apt-get update
    - apt-get -y install curl
  script:
    - mkdir -p .public/build/reports
    - cd .public
    - gcovr -j$(($(nproc)/2 > 0 ? $(nproc)/2:1)) -r ../ -a ../build/run-unit.json --xml -o build/reports/code-coverage.xml
    - gcovr -j$(($(nproc)/2 > 0 ? $(nproc)/2:1)) -r ../ -a ../build/run-unit.json --html --html-details -o index.html
    - cp ../build/unittests.xml build/reports/unit-tests.xml
    # Create and upload GitLab badges
    - chmod -R 700 ../CI
    - python3 ../CI/.produce-ci-metrics.py build/reports > build/reports/ci-metrics.json
    - sh ../CI/ci-badges-func.sh
    - cd ..
    - mv .public public
  artifacts:
    paths:
      - public
    reports:
      cobertura: public/build/reports/code-coverage.xml
  rules:
    - <<: *if_not_astron_repo

check-stack:
  variables:
    # Pass commit hash to downstream pipeline
    IDG_TRIGGER_HASH: $CI_COMMIT_SHA
  stage: integration_and_deploy
  needs: []
  trigger:
    project: RD/schaap-stack
    branch: master
    # This will mirror the status of the downstream pipeline
    strategy: depend
  rules:
    # Only add job for a merge request event
    - <<: *if_not_astron_repo
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - when: never
