# This step determines the SHA1 of the Docker file used. It's stored in
# versions.env artiface. The environment variables are available for all steps
# depending on this step.
versioning:
  stage: .pre
  image: bitnami/git
  script:
    - echo BASE_IMAGE=${CI_REGISTRY_IMAGE}/base:$(git log -n 1 --pretty=format:%H -- ci/ubuntu_20_04) > versions.env
    - cat versions.env
  artifacts:
    reports:
      dotenv: versions.env

# Builds the Docker image containing the dependencies of the Rapthor pipeline.
# This image is cached, as long as the Dockerfile isn't modified new jobs reuse
# this image.
build-docker-ubuntu-20.04:
  stage: .pre
  needs: ["versioning"]
  image: docker:latest
  script:
    - |
      if ! docker manifest inspect $BASE_IMAGE > /dev/null; then
        docker build --tag $BASE_IMAGE -f ci/ubuntu_20_04 .
        docker push $BASE_IMAGE
      fi
  before_script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY

# Executes the tests of the Rapthor pipeline.
build-ubuntu-20.04:
  stage: test
  needs: ["versioning", "build-docker-ubuntu-20.04"]
  image: $BASE_IMAGE
  script:
    - ci/run.sh
